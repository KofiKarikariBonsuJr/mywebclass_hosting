version: '3.8'

# Educational Web Hosting Stack - Caddy Reverse Proxy
# This configuration sets up Caddy as a reverse proxy with automatic SSL

services:
  # Caddy reverse proxy with automatic HTTPS
  caddy:
    image: caddy:2.8-alpine
    container_name: caddy
    restart: unless-stopped
    
    # Network ports
    ports:
      - "80:80"     # HTTP (redirects to HTTPS)
      - "443:443"   # HTTPS (SSL/TLS)
      - "443:443/udp"  # HTTP/3 QUIC
    
    # Configuration and data volumes
    volumes:
      # Main configuration file
      - ./Caddyfile:/etc/caddy/Caddyfile:ro
      # Persistent data (SSL certificates, etc.)
      - ./data:/data
      # Configuration cache
      - ./config:/config
      # Log files
      - ./logs:/var/log/caddy
    
    # Environment variables
    environment:
      - CADDY_INGRESS_NETWORKS=web
    
    # Networks
    networks:
      - web
      - internal
    
    # Health check
    healthcheck:
      test: ["CMD", "caddy", "validate", "--config", "/etc/caddy/Caddyfile"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    
    # Security settings
    security_opt:
      - no-new-privileges:true
    
    # Labels for documentation
    labels:
      - "traefik.enable=false"  # Don't proxy this service
      - "edu.mywebclass.service=reverse-proxy"
      - "edu.mywebclass.description=Caddy reverse proxy with auto SSL"

  # Example main website (students will replace this)
  main-site:
    image: nginx:alpine
    container_name: main-site
    restart: unless-stopped
    
    volumes:
      # Website content
      - ../examples/main-site:/usr/share/nginx/html:ro
      # Custom nginx config if needed
      # - ./nginx.conf:/etc/nginx/nginx.conf:ro
    
    # Only internal network access (via Caddy)
    networks:
      - internal
    
    # Health check
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost/"]
      interval: 30s
      timeout: 10s
      retries: 3
    
    # Labels for documentation
    labels:
      - "edu.mywebclass.service=main-website"
      - "edu.mywebclass.description=Main website content"

# Networks
networks:
  # External network for internet-facing services
  web:
    name: web
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16
  
  # Internal network for backend services
  internal:
    name: internal
    driver: bridge
    internal: true
    ipam:
      config:
        - subnet: 172.21.0.0/16

# Volumes (for persistent data)
volumes:
  caddy_data:
    driver: local
  caddy_config:
    driver: local

# Additional notes for students:
# 1. This setup provides automatic HTTPS for all domains in Caddyfile
# 2. Add new services by copying the main-site service block
# 3. Connect services to 'internal' network for security
# 4. Caddy handles SSL certificates automatically via Let's Encrypt
# 5. View logs with: docker compose logs -f caddy